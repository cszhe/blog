<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="omale" />
        <meta name="copyright" content="omale" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content=", misc, " />

<meta property="og:title" content="一次Windows CE下调试内存泄露的经历 "/>
<meta property="og:url" content="./yi-ci-windows-cexia-diao-shi-nei-cun-xie-lu-de-jing-li.html" />
<meta property="og:description" content="未分类 计算机技术 tags: Windows CE 嵌入式 上周二，软院的万老师打电话告诉我，说汽车学院以前写的一个Windows CE程序内存泄露比较严重。想让我帮忙调试一下。结果上一周都没有时间，昨天周一到软院上课的时候，听王老师说那个泄露程序已经惊动了同济大学校长万钢，因为他要拿那个程序给领导演示，不能再拖了。偶颇有点临危受命的感觉。晚上下了课，就一头扎到研发中心的机器前，开始工作。 这是一个电子仪表程序，代码从串口读取汽车数据，包括车速，油亮，车轮转速等等，然后解析数据，并把数据显示在屏幕上。在研华7230的开发板上运行，结果不出10秒钟就弹出对话框，Out of Memory! Win CE这个小嵌入式系统，每个进程只有32M的虚拟地址空间。他那个程序本身就有4M的样子（因为有太多的图片）。 我首先想到的是把这个程序在Windows上重新编译运行，因为毕竟这段代码没有用到什么Windows CE特有的函数，全是通用的Win32 API。而且在Windows下调试内存泄露还有大量的工具和经验可以利用。说干就干，打开VC6，新建一个工程，Copy文件，编译，几个小Error拦不住我，马上一个Executable …" />
<meta property="og:site_name" content="Zongjian&#39;s blog" />
<meta property="og:article:author" content="omale" />
<meta property="og:article:published_time" content="2004-11-03T00:41:00+00:00" />
<meta name="twitter:title" content="一次Windows CE下调试内存泄露的经历 ">
<meta name="twitter:description" content="未分类 计算机技术 tags: Windows CE 嵌入式 上周二，软院的万老师打电话告诉我，说汽车学院以前写的一个Windows CE程序内存泄露比较严重。想让我帮忙调试一下。结果上一周都没有时间，昨天周一到软院上课的时候，听王老师说那个泄露程序已经惊动了同济大学校长万钢，因为他要拿那个程序给领导演示，不能再拖了。偶颇有点临危受命的感觉。晚上下了课，就一头扎到研发中心的机器前，开始工作。 这是一个电子仪表程序，代码从串口读取汽车数据，包括车速，油亮，车轮转速等等，然后解析数据，并把数据显示在屏幕上。在研华7230的开发板上运行，结果不出10秒钟就弹出对话框，Out of Memory! Win CE这个小嵌入式系统，每个进程只有32M的虚拟地址空间。他那个程序本身就有4M的样子（因为有太多的图片）。 我首先想到的是把这个程序在Windows上重新编译运行，因为毕竟这段代码没有用到什么Windows CE特有的函数，全是通用的Win32 API。而且在Windows下调试内存泄露还有大量的工具和经验可以利用。说干就干，打开VC6，新建一个工程，Copy文件，编译，几个小Error拦不住我，马上一个Executable …">

        <title>一次Windows CE下调试内存泄露的经历  · Zongjian&#39;s blog
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="./theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/custom.css" media="screen">
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Zongjian&#39;s blog - Full Atom Feed" />
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="./"><span class=site-name>Zongjian's blog</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href=".">Home</a></li>
                            <li ><a href="./categories.html">Categories</a></li>
                            <li ><a href="./tags.html">Tags</a></li>
                            <li ><a href="./archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="./search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page-header span10 offset2">
    <h1><a href="./yi-ci-windows-cexia-diao-shi-nei-cun-xie-lu-de-jing-li.html"> 一次Windows CE下调试内存泄露的经历  </a></h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">

            
            <ul>
<li>未分类</li>
<li>计算机技术
tags:</li>
<li>Windows CE</li>
<li>嵌入式</li>
</ul>
<hr>
<p>上周二，软院的万老师打电话告诉我，说汽车学院以前写的一个Windows&nbsp;CE程序内存泄露比较严重。想让我帮忙调试一下。结果上一周都没有时间，昨天周一到软院上课的时候，听王老师说那个泄露程序已经惊动了同济大学校长万钢，因为他要拿那个程序给领导演示，不能再拖了。偶颇有点临危受命的感觉。晚上下了课，就一头扎到研发中心的机器前，开始工作。</p>
<p>这是一个电子仪表程序，代码从串口读取汽车数据，包括车速，油亮，车轮转速等等，然后解析数据，并把数据显示在屏幕上。在研华7230的开发板上运行，结果不出10秒钟就弹出对话框，Out&nbsp;of&nbsp;Memory!&nbsp;Win&nbsp;CE这个小嵌入式系统，每个进程只有32M的虚拟地址空间。他那个程序本身就有4M的样子（因为有太多的图片）。</p>
<p>我首先想到的是把这个程序在Windows上重新编译运行，因为毕竟这段代码没有用到什么Windows&nbsp;CE特有的函数，全是通用的Win32&nbsp;API。而且在Windows下调试内存泄露还有大量的工具和经验可以利用。说干就干，打开VC6，新建一个工程，Copy文件，编译，几个小Error拦不住我，马上一个Executable&nbsp;File就出来了。下面安装在GTEC时候常用的LeakDiag和Numega的BoundsChecker。但是，出乎我意料的是，这个程序无论是用LeakDiag还是BoundsChecker，都没有检测到大规模的内存泄露，只有一个HBRUSH的HANDLE没有释放，这个不可能成为Out&nbsp;Of&nbsp;Memory的原因。而且使用Windows的任务管理器和Performance&nbsp;Monitor查看，进程的物理内存，虚拟内存和GDI句柄数都很稳定，没有上升。第一次尝试失败了。</p>
<p>但是，这个程序在Windows&nbsp;CE开发板上跑，的确是会内存泄露的。下面，我想到既然在Windows下面不会泄露，那么会不会是研华提供的BSP的显示驱动程序有内存泄露呢？这个主意马上被我否决了。如果是显示驱动有内存泄露，根本不用等到跑这个程序才会Out&nbsp;of&nbsp;Memory。单单跑Windows&nbsp;CE就足以让整个系统Crash了。</p>
<p>走到这步，内存泄漏的原因我也说不清了。那就先看看到底是哪些代码在泄。好在Microsft为Windows&nbsp;CE提供了Remote&nbsp;Performance&nbsp;Monitor工具，通过ActiveSync，我们可以在PC机上远程查看Windows&nbsp;CE上的一些信息。这样，通过查看那个程序的Heap&nbsp;Memory使用情况，不就可以找到内存泄露的地方了么？</p>
<p>我打开Platform&nbsp;Builder，使用研华的BSP重新编译了一个支持ActiveSync的平台，然后在这个平台上跑了一下那个程序，泄漏依旧。打开EVC，终于，现在可以借助ActiveSync一步一步地在远程开发板上调试了。首先启动应用程序，然后再打开Remote&nbsp;Performance&nbsp;Monitor监测进程的Heap&nbsp;Memory。经过几个回合的查找，我终于找到是在这个程序的计时器重画的时候，有五个函数导致内存泄露，五个函数的代码差不多，大致都像下面一样：</p>
<p>void&nbsp;CEvcFCVDlg::ClockPainting_N(double&nbsp;dblClockStartData,&nbsp;double&nbsp;dblClockEndData,&nbsp;double&nbsp;dblClockStartAngel,&nbsp;double&nbsp;dblClockEndAngel,&nbsp;double&nbsp;dblClockData,&nbsp;int&nbsp;nClockLength,&nbsp;int&nbsp;nClockLengthOffset,&nbsp;int&nbsp;nStartWidth,&nbsp;int&nbsp;nEndWidth,&nbsp;int&nbsp;nColorRGB,&nbsp;int&nbsp;nPicture,&nbsp;CPoint&nbsp;CPOrintalOffset)</p>
<p>{</p>
<p>int&nbsp;nWidth;</p>
<p>&nbsp;int&nbsp;nHeight;</p>
<p>&nbsp;</p>
<p>&nbsp;int&nbsp;nPenWidth=0;</p>
<p>&nbsp;CRect&nbsp;crecXY;</p>
<p>&nbsp;CRect&nbsp;rect;</p>
<p>&nbsp;int&nbsp;xLength=0;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;yLength=0;</p>
<p>&nbsp;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;CWnd*&nbsp;pWnd=GetDlgItem(nPicture);</p>
<p>&nbsp;CDC*&nbsp;pDC=pWnd-&gt;GetDC();</p>
<p>&nbsp;pWnd-&gt;UpdateWindow();</p>
<p>&nbsp;pWnd-&gt;GetWindowRect(rect);</p>
<p>&nbsp;pWnd-&gt;GetWindowRect(crecXY);</p>
<p>&nbsp;</p>
<p>&nbsp;nWidth=rect.Width();</p>
<p>&nbsp;nHeight=rect.Height();</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p>&nbsp;CDC&nbsp;&nbsp;MemDC;</p>
<p>&nbsp;CBitmap&nbsp;&nbsp;MemBitmap;</p>
<p>&nbsp;</p>
<p>&nbsp;MemDC.CreateCompatibleDC&nbsp;(NULL);</p>
<p>&nbsp;MemBitmap.CreateCompatibleBitmap(pDC,nWidth,nHeight);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p>&nbsp;CBitmap&nbsp;*pOldBit=MemDC.SelectObject(&amp;MemBitmap);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MemDC.FillSolidRect(0,0,nWidth,nHeight,RGB(255,255,255));</p>
<p>&nbsp;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//////////////////////////////////////////////&nbsp;&nbsp;&nbsp;</p>
<p>&nbsp;pWnd-&gt;GetClientRect(rect);</p>
<p>&nbsp;BITMAP&nbsp;bm;</p>
<p>&nbsp;CDC&nbsp;dcMem;</p>
<p>&nbsp;m_bmpN.GetObject(sizeof(bm),&amp;bm);&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p>&nbsp;dcMem.CreateCompatibleDC(pDC);</p>
<p>&nbsp;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;CBitmap&nbsp;*pOldBMP&nbsp;=(CBitmap*)dcMem.SelectObject(&amp;m_bmpN);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p>&nbsp;MemDC.BitBlt(&nbsp;(rect.right-bm.bmWidth)/2,(rect.bottom-bm.bmHeight)/2,bm.bmWidth,bm.bmHeight,&amp;dcMem,0,0,SRCCOPY);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p>&nbsp;dcMem.SelectObject(pOldBMP);</p>
<p>&nbsp;&nbsp;&nbsp;</p>
<p>&nbsp;/////////////////////////////////////////</p>
<p>&nbsp;double&nbsp;dblADk=-1;//计算作图角度时的系数。</p>
<p>&nbsp;double&nbsp;dblClockAngel;</p>
<p>&nbsp;if((dblClockEndAngel-dblClockStartAngel)&lt;0){</p>
<p>&nbsp;dblADk=(360+(dblClockEndAngel-dblClockStartAngel))/(dblClockEndData-dblClockStartData);</p>
<p>&nbsp;}</p>
<p>&nbsp;else{</p>
<p>&nbsp;dblADk=(dblClockEndAngel-dblClockStartAngel)/(dblClockEndData-dblClockStartData);</p>
<p>&nbsp;}</p>
<p>&nbsp;</p>
<p>&nbsp;nClockLength=(nClockLength)/(nStartWidth-nEndWidth);</p>
<p>&nbsp;</p>
<p>&nbsp;//计算dblClockAngel,最后化成弧度;</p>
<p>&nbsp;dblClockAngel=(3.1416/180)*((dblClockData-dblClockStartData)*dblADk+dblClockStartAngel);</p>
<p>&nbsp;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p>&nbsp;xLength=crecXY.Width()/2+CPOrintalOffset.x;</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;yLength=crecXY.Height()/2+CPOrintalOffset.y;</p>
<p>&nbsp;</p>
<p>&nbsp;for(int&nbsp;i=nStartWidth;i&gt;nEndWidth;&#8211;i)</p>
<p>&nbsp;{</p>
<p>&nbsp;nPenWidth=i;</p>
<p>&nbsp;CPen&nbsp;newPen(PS_SOLID,nPenWidth,nColorRGB);//RGB(0,0,255)</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CPen*&nbsp;pOldPen=MemDC.SelectObject(&amp;newPen);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MemDC.MoveTo(xLength+nClockLengthOffset*cos(dblClockAngel),yLength+nClockLengthOffset*sin(dblClockAngel));</p>
<p>&nbsp;MemDC.LineTo((nClockLength*(nStartWidth-i)+nClockLengthOffset)*cos(dblClockAngel)+xLength,(nClockLength*(nStartWidth-i)+nClockLengthOffset)*sin(dblClockAngel)+yLength);&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;if(i==nStartWidth)</p>
<p>&nbsp;MemDC.SetPixel(xLength+nClockLengthOffset*cos(dblClockAngel),yLength+nClockLengthOffset*sin(dblClockAngel),nColorRGB);</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p>&nbsp;MemDC.SelectObject(pOldPen);</p>
<p>&nbsp;}</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//////////////////////////////////////////////</p>
<p>&nbsp;</p>
<p>&nbsp;pDC-&gt;BitBlt(0,0,nWidth,nHeight,&amp;MemDC,0,0,SRCCOPY);</p>
<p>&nbsp;pWnd-&gt;ReleaseDC&nbsp;(pDC);&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p>&nbsp;MemBitmap.DeleteObject();</p>
<p>&nbsp;MemDC.DeleteDC();</p>
<p>}</p>
<p>然后，我又调试了几轮，最后终于把泄漏的代码定位到了这一行：</p>
<p>MemBitmap.CreateCompatibleBitmap(pDC,nWidth,nHeight);</p>
<p>也就是说，创建的Bitmap没有被释放掉。但是，这段代码的最后面，的确有MemBitmap.DeleteObject();来释放bitmap阿。我打开Windows&nbsp;CE的MSDN，查找CreaeteCompatibleBitmap和DeleteObject的解释，一会儿，我的目光锁定在了DeleteObject的解释上：Zero&nbsp;indicates&nbsp;that&nbsp;the&nbsp;specified&nbsp;handle&nbsp;is&nbsp;not&nbsp;valid&nbsp;or&nbsp;that&nbsp;the&nbsp;handle&nbsp;is&nbsp;currently&nbsp;selected&nbsp;into&nbsp;a&nbsp;device&nbsp;context.&nbsp;对！会不会是DeleteObject失败了呢？我把那句话改成了BOOL&nbsp;fRet&nbsp;=&nbsp;MemBitmap.DeleteObject();&nbsp;果然，返回值是0！再仔细查看一下上面的代码，我发现这个时候MemBitmap的确被MemDC占用！好，既然是这样，在</p>
<p>pDC-&gt;BitBlt(0,0,nW idth,nHeight,&amp;MemDC,0,0,SRCCOPY);</p>
<p>pWnd-&gt;ReleaseDC&nbsp;(pDC);</p>
<p>两句之间添加一行MemDC-&gt;SelectObject(pOldBit);&nbsp;然后再跑一下，果然，DeleteObject成功了！那么，内存泄漏是否就此解决了呢？我把代码编译成Release版本，然后在开发板上重新跑了起来，结果真没让人失望，10分钟过去了，那个讨厌的Out&nbsp;of&nbsp;Memory对话框还没有跳出来。搞定！这个时候，机房关门的时间也到了。颇有点最后一刻投篮中的扭转乾坤的感觉！</p>
<p>回招待所的路上，我都很兴奋，好久都没有从Coding中体会到成就感的乐趣了，记得刚刚转到软院，写那个简单的扫雷和画图的时候，当实现了扫雷的递归翻开和画图的Redo，&nbsp;UnDo的时候，曾经有过这样的感觉。回到招待所，给GF发了条短信，希望她也能分享我的快乐。</p>
<p>总结一下，可以有这么一些经验教训：</p>
<p>1．Windows&nbsp;CE和Windows虽然都使用Win&nbsp;32&nbsp;API作为编程接口，但是API内部的实现是不一样的。同样的代码，那个程序在Windows下Bitmap可以正常删除，但是在CE下，DeleteObject就失败了。</p>
<p>2．Windows下的调试技巧，还是可以拿来Windows&nbsp;CE上用的。就像那本书上说的&ldquo;It&rsquo;s&nbsp;still&nbsp;Windows&nbsp;Programming&rdquo;</p>
<p>3．不要轻易去怀疑是操作系统的bug，遇到问题先从自己那里着手。</p>
<p>4．Enjoy&nbsp;the&nbsp;joy&nbsp;of&nbsp;coding！</p>
            
            
            <hr/>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2004-11-03T00:41:00+00:00">Nov 3, 2004</time>
            <h4>Category</h4>
            <a class="category-link" href="./categories.html#misc-ref">misc</a>
<h4>Contact</h4>
    <a href="#" title="My You can add links in your config file Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-you can add links in your config file sidebar-social-links"></i></a>
    <a href="#" title="My Another social link Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-another social link sidebar-social-links"></i></a>
        </div>
        </section>
</div>
</article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a></li>
    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    
    </body>
    <!-- Theme: Elegant built for Pelican
    License : http://oncrashreboot.com/pelican-elegant -->
</html>