<!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->

{% capture result_elem %}
  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">
    <header>
      <h2><a href="{url}">{title}</a></h2>
      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">
        {categories}
        {tags}
      </div>
    </header>
    <p>{snippet}</p>
  </article>
{% endcapture %}

{% capture not_found %}<p class="mt-5">{{ site.data.locales[include.lang].search.no_results }}</p>{% endcapture %}

<script>
  {% comment %} Note: dependent library will be loaded in `js-selector.html` {% endcomment %}
  console.log('[DEBUG] Search loader starting...');
  
  function initSearch() {
    console.log('[DEBUG] initSearch called, SimpleJekyllSearch:', typeof SimpleJekyllSearch);
    if (typeof SimpleJekyllSearch === 'undefined') {
      console.log('[DEBUG] SimpleJekyllSearch not loaded yet, retrying...');
      setTimeout(initSearch, 100);
      return;
    }
    console.log('[DEBUG] Initializing SimpleJekyllSearch...');
    try {
      const searchInput = document.getElementById('search-input');
      const resultsContainer = document.getElementById('search-results');
      console.log('[DEBUG] searchInput:', searchInput);
      console.log('[DEBUG] resultsContainer:', resultsContainer);
      console.log('[DEBUG] json path: /assets/js/data/search.json');
      
      SimpleJekyllSearch({
        searchInput: searchInput,
        resultsContainer: resultsContainer,
        json: '/assets/js/data/search.json',
        searchResultTemplate: '{{ result_elem | strip_newlines }}',
        noResultsText: '{{ not_found }}',
        templateMiddleware: function(prop, value, template) {
          if (prop === 'categories') {
            if (value === '') {
              return `${value}`;
            } else {
              return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
            }
          }

          if (prop === 'tags') {
            if (value === '') {
              return `${value}`;
            } else {
              return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
            }
          }
        }
      });
      console.log('[DEBUG] SimpleJekyllSearch initialized successfully');
      
      // Add Enter key listener - manually trigger search
      searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          console.log('[DEBUG] Enter key pressed, triggering search for:', searchInput.value);
          e.preventDefault();
          searchInput.dispatchEvent(new Event('input'));
          console.log('[DEBUG] Input event dispatched');
          console.log('[DEBUG] Results container innerHTML:', resultsContainer.innerHTML.substring(0, 200));
          
          // Show results wrapper
          const resultWrapper = document.getElementById('search-result-wrapper');
          console.log('[DEBUG] resultWrapper:', resultWrapper);
          console.log('[DEBUG] resultWrapper classes:', resultWrapper.className);
          resultWrapper.classList.remove('d-none');
          console.log('[DEBUG] resultWrapper classes after:', resultWrapper.className);
        }
      });
    } catch (e) {
      console.error('[DEBUG] Error initializing SimpleJekyllSearch:', e);
    }
  }
  initSearch();
</script>
