<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>在boot loader中加入启动画面及插值算法 | Zongjian’s blog</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="在boot loader中加入启动画面及插值算法" />
<meta name="author" content="omale" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="最近有个朋友希望我帮忙给他的一块板子加一个启动画面。板子是用烂了的三星2410处理器。 不同之处就在于他的板子是640 x 480 VGA输出，而不是通常的240 x 320的LCD。" />
<meta property="og:description" content="最近有个朋友希望我帮忙给他的一块板子加一个启动画面。板子是用烂了的三星2410处理器。 不同之处就在于他的板子是640 x 480 VGA输出，而不是通常的240 x 320的LCD。" />
<link rel="canonical" href="https://www.hezongjian.com/zai-boot-loaderzhong-jia-ru-qi-dong-hua-mian-ji-cha-zhi-suan-fa.html" />
<meta property="og:url" content="https://www.hezongjian.com/zai-boot-loaderzhong-jia-ru-qi-dong-hua-mian-ji-cha-zhi-suan-fa.html" />
<meta property="og:site_name" content="Zongjian’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2007-10-24T06:13:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="在boot loader中加入启动画面及插值算法" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"omale"},"dateModified":"2007-10-24T06:13:00-04:00","datePublished":"2007-10-24T06:13:00-04:00","description":"最近有个朋友希望我帮忙给他的一块板子加一个启动画面。板子是用烂了的三星2410处理器。 不同之处就在于他的板子是640 x 480 VGA输出，而不是通常的240 x 320的LCD。","headline":"在boot loader中加入启动画面及插值算法","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.hezongjian.com/zai-boot-loaderzhong-jia-ru-qi-dong-hua-mian-ji-cha-zhi-suan-fa.html"},"url":"https://www.hezongjian.com/zai-boot-loaderzhong-jia-ru-qi-dong-hua-mian-ji-cha-zhi-suan-fa.html"}</script>
<!-- End Jekyll SEO tag -->
<link id="main-stylesheet" rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://www.hezongjian.com/feed.xml" title="Zongjian&apos;s blog" />
</head>
<body><header class="site-header" role="banner">
  <div class="wrapper"><a class="site-title" rel="author" href="/">Zongjian&#39;s blog</a>

    <nav class="site-nav">
      <a class="page-link" href="/">Home</a>
      <a class="page-link" href="/categories/">Categories</a>
      <a class="page-link" href="/tags/">Tags</a>
      <a class="page-link" href="/archive/">Archive</a>
    </nav>
  </div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">在boot loader中加入启动画面及插值算法</h1>
    <div class="post-meta">
      <time class="dt-published" datetime="2007-10-24T06:13:00-04:00" itemprop="datePublished">
        October 24, 2007
      </time></div>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>最近有个朋友希望我帮忙给他的一块板子加一个启动画面。板子是用烂了的三星2410处理器。 不同之处就在于他的板子是640 x 480 VGA输出，而不是通常的240 x 320的LCD。</p>

<p>在Windows CE中，通常加入启动画面的方法很土，因为OS没有启动，所以没有什么BitBlt，StretchBlt等方法可以贴图，唯一的方法就是在启动的过程中，直接往显卡的Framebuffer里面写数据。这个工作一般在Boot Loader里面做，如果在OS启动的时候一般就太晚了，如果不加入人为的延时，启动画面刚一显示，就到了OS画面了。做法一般是这样，在Boot Loader里面：</p>

<p>BOOL OEMPlatformInit()<br />
{<br />
…………………………</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Init the Display  
InitDisplay();
</code></pre></div></div>

<p>…………………………<br />
}</p>

<p>然后是InitDisplay函数一般如下所示：<br />
static void InitDisplay()<br />
{<br />
    int i = 0;<br />
 int j = 0;<br />
    volatile IOPreg *s2410IOP;<br />
    volatile LCDreg *s2410LCD;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>s2410IOP = (IOPreg *)IOP_BASE;  
s2410LCD = (LCDreg *)LCD_BASE; 

// LCD port initialize.  
s2410IOP-&gt;rGPCUP  = 0xFFFFFFFF;  
s2410IOP-&gt;rGPCCON = 0xAAAAAAAA;  
s2410IOP-&gt;rGPCCON = 0xAAAAAAAA;

s2410IOP-&gt;rGPDUP  = 0xFFFFFFFF;  
s2410IOP-&gt;rGPDCON = 0xAAAAAAAA;

s2410IOP-&gt;rGPGCON &amp;= ~(3 &lt;&lt; 8);                 /\* Set LCD_PWREN as output                          \*/  
s2410IOP-&gt;rGPGCON |=  (1 &lt;&lt; 8);

s2410IOP-&gt;rGPGDAT |=  (1 &lt;&lt; 4);                 /\* Backlight ON                                     \*/
</code></pre></div></div>

<p>s2410LCD-&gt;rLCDCON1=(1«8)|(MVAL_USED«7)|(3«5)|(12«1)|0;<br />
        // TFT LCD panel,16bpp TFT,ENVID=off<br />
 s2410LCD-&gt;rLCDCON2=(VBPD«24)|(LINEVAL_TFT«14)|(VFPD«6)|(VSPW);<br />
 s2410LCD-&gt;rLCDCON3=(HBPD«19)|(HOZVAL_TFT«8)|(HFPD);<br />
 s2410LCD-&gt;rLCDCON4=(MVAL«8)|(HSPW);<br />
 s2410LCD-&gt;rLCDCON5=(1«11)|(1«9)|(1«8)|(1«3)|(1«0); //FRM5:6:5,HSYNC and VSYNC are inverted<br />
 s2410LCD-&gt;rLCDSADDR1=((FRAMEBUF_DMA_BASE»22)«21)|M5D(FRAMEBUF_DMA_BASE»1);<br />
 s2410LCD-&gt;rLCDSADDR2=M5D( (FRAMEBUF_DMA_BASE+(LCD_XSIZE_TFT*LCD_YSIZE_TFT*2))»1 );<br />
 s2410LCD-&gt;rLCDSADDR3=(((LCD_XSIZE_TFT-LCD_XSIZE_TFT)/1)«11)|(LCD_XSIZE_TFT/1);<br />
 //s2410LCD-&gt;rLCDINTMSK|=(3); // MASK LCD Sub Interrupt<br />
 s2410LCD-&gt;rLPCSEL&amp;=(~7); // Disable LPC3600<br />
 s2410LCD-&gt;rTPAL=0; // Disable Temp Palette</p>

<table>
  <tbody>
    <tr>
      <td>s2410LCD-&gt;rLCDCON1</td>
      <td>= 1;</td>
    </tr>
  </tbody>
</table>

<p>// Display a bitmap image on the LCD…<br />
    //memcpy((void *)FRAMEBUF_BASE, ScreenBitmap, ARRAY_SIZE_TFT_16BIT);</p>

<p>// Jason : Interpolation</p>

<p>EdbgOutputDebugString(“+Interpolation\r\n”);</p>

<p>for(i = 0; i &lt; 320 * 240; i++)<br />
 {<br />
  PWORD pWord = (PWORD)ScreenBitmap;<br />
  PWORD pFrmBuf = (PWORD)FRAMEBUF_BASE;</p>

<p>pFrmBuf[4 * i – 2 * (i % 320)] = pWord[i];<br />
  pFrmBuf[4 * i – 2 * (i % 320) + 1] = pWord[i];<br />
  pFrmBuf[4 * i – 2 * (i % 320) + 320 * 2] = pWord[i];<br />
  pFrmBuf[4 * i – 2 * (i % 320) + 1 + 320 * 2] = pWord[i];</p>

<p>}</p>

<p>前面初始化硬件的代码没什么好看的。<br />
注意到memcpy((void *)FRAMEBUF_BASE, ScreenBitmap, ARRAY_SIZE_TFT_16BIT);这一句，这就是显示启动画面的关键了，直接调用memcpy函数，把一个大数组，复制到了FRAMEBUF_BASE这个地址。这个其实就是直接往显卡缓冲区里面填东西了。至于这个大数组，可以用Image2LCD等类似软件生成，也就是直接把一张位图转成C语言数组的软件，这东西在游戏开发中用的比较多。</p>

<p>一般情况下，这种方法都是OK的，但是现在遇到什么问题呢？</p>

<p>因为目标设备的显示分辨率是640 x 480 x 16位的，所以这个大数组需要多大的存储空间是可以算出来的：640 * 480 * 2 = 600KB。但是对于一般的boot loader而言，板子上不会划分这么大的空间给boot loader用，一般boot loader的空间只有256KB。（其实可以人为改，只不过这个板子用linux的loader 引导CE的loader，才产生这么多问题）。所以解决方法只能有下面两条：</p>

<ol>
  <li>压缩，然后在运行时候解压缩，然后再memcpy。可以找一些最基本的通用开源压缩算法来完成。</li>
  <li>插值，弄一张小图片，把它插值到640 x 480。</li>
</ol>

<p>两者权衡，偶还是决定采用插值的办法，这样的工作量还是小一些的。其实也就是自己把StretchBlt函数实现了。</p>

<p>哎，本科的时候没有开设图形学，所以也不知道插值有没有具体的公式，只能自己推导了。好在这个不是一个通用的算法，只是放大4倍的这样一个特例。一个点变四个点，还是很容易的。自己拿着纸笔比划了一阵子，终于得出个公式来，公式不好帖，直接帖代码就是下面这样：</p>

<p>for(i = 0; i &lt; 320 * 240; i++)<br />
 {<br />
  PWORD pWord = (PWORD)ScreenBitmap;<br />
  PWORD pFrmBuf = (PWORD)FRAMEBUF_BASE;</p>

<p>pFrmBuf[4 * i – 2 * (i % 320)] = pWord[i];<br />
  pFrmBuf[4 * i – 2 * (i % 320) + 1] = pWord[i];<br />
  pFrmBuf[4 * i – 2 * (i % 320) + 320 * 2] = pWord[i];<br />
  pFrmBuf[4 * i – 2 * (i % 320) + 1 + 320 * 2] = pWord[i];<br />
 }</p>

<p>只不过这次准备的是一张320 x 240的照片，然后采用一重的循环，把它写到framebuffer相应的位置去。</p>

<p>最终的效果还是不错的，不知道插值有没有更好的公式。如果有，也请告诉偶。呵呵。</p>

  </div>

  <a class="u-url" href="/zai-boot-loaderzhong-jia-ru-qi-dong-hua-mian-ji-cha-zhi-suan-fa.html" hidden></a>
</article>


      </div>
    </main><link id="fa-stylesheet" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.0.0/css/all.min.css">

<footer class="site-footer h-card">
  <data class="u-url" value="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <ul class="contact-list">
          <li class="p-name">Zongjian He</li>
          <li><a class="u-email" href="mailto:"></a></li>
        </ul>
      </div>
      <div class="footer-col">
        <p>Personal blog of Zongjian He</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list">
  <li>
    <a href="https://www.hezongjian.com/feed.xml" target="_blank" title="Subscribe to syndication feed">
      <svg class="svg-icon grey" viewbox="0 0 16 16">
        <path d="M12.8 16C12.8 8.978 7.022 3.2 0 3.2V0c8.777 0 16 7.223 16 16h-3.2zM2.194
          11.61c1.21 0 2.195.985 2.195 2.196 0 1.21-.99 2.194-2.2 2.194C.98 16 0 15.017 0
          13.806c0-1.21.983-2.195 2.194-2.195zM10.606
          16h-3.11c0-4.113-3.383-7.497-7.496-7.497v-3.11c5.818 0 10.606 4.79 10.606 10.607z"
        />
      </svg>
    </a>
  </li>
</ul>
</div>

  </div>

</footer>

</body>

</html>
