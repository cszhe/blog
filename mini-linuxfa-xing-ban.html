<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Mini Linux发行版 | Zongjian’s blog</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Mini Linux发行版" />
<meta name="author" content="Zongjian He" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="发行版跟内核比, 复杂多了. 你得有个安装程序, 有个包管理器, 有个软件仓库, 有个GUI, 有个桌面, 有个窗口管理器, 有个登录管理器, 有个网络管理器, 有个音频管理器, 有个电源管理器, 有个文件管理器, 有个文本编辑器, 有个终端模拟器, 有个浏览器, 有个邮件客户端, 有个音乐播放器, 有个视频播放器, 有个图片查看器, 有个PDF阅读器, 有个打印机管理器, 有个截图工具, 有个录屏工具, 有个截屏工具, 有个系统监控工具, 有个系统设置工具, 有个系统日志工具, 有个系统更新工具, 有个系统备份工具, 有个系统还原工具…… 但是核心的东西其实就三块:" />
<meta property="og:description" content="发行版跟内核比, 复杂多了. 你得有个安装程序, 有个包管理器, 有个软件仓库, 有个GUI, 有个桌面, 有个窗口管理器, 有个登录管理器, 有个网络管理器, 有个音频管理器, 有个电源管理器, 有个文件管理器, 有个文本编辑器, 有个终端模拟器, 有个浏览器, 有个邮件客户端, 有个音乐播放器, 有个视频播放器, 有个图片查看器, 有个PDF阅读器, 有个打印机管理器, 有个截图工具, 有个录屏工具, 有个截屏工具, 有个系统监控工具, 有个系统设置工具, 有个系统日志工具, 有个系统更新工具, 有个系统备份工具, 有个系统还原工具…… 但是核心的东西其实就三块:" />
<link rel="canonical" href="https://www.hezongjian.com/mini-linuxfa-xing-ban.html" />
<meta property="og:url" content="https://www.hezongjian.com/mini-linuxfa-xing-ban.html" />
<meta property="og:site_name" content="Zongjian’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-01-10T18:06:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Mini Linux发行版" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Zongjian He"},"dateModified":"2024-01-10T18:06:00-05:00","datePublished":"2024-01-10T18:06:00-05:00","description":"发行版跟内核比, 复杂多了. 你得有个安装程序, 有个包管理器, 有个软件仓库, 有个GUI, 有个桌面, 有个窗口管理器, 有个登录管理器, 有个网络管理器, 有个音频管理器, 有个电源管理器, 有个文件管理器, 有个文本编辑器, 有个终端模拟器, 有个浏览器, 有个邮件客户端, 有个音乐播放器, 有个视频播放器, 有个图片查看器, 有个PDF阅读器, 有个打印机管理器, 有个截图工具, 有个录屏工具, 有个截屏工具, 有个系统监控工具, 有个系统设置工具, 有个系统日志工具, 有个系统更新工具, 有个系统备份工具, 有个系统还原工具…… 但是核心的东西其实就三块:","headline":"Mini Linux发行版","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.hezongjian.com/mini-linuxfa-xing-ban.html"},"url":"https://www.hezongjian.com/mini-linuxfa-xing-ban.html"}</script>
<!-- End Jekyll SEO tag -->
<link id="main-stylesheet" rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://www.hezongjian.com/feed.xml" title="Zongjian&apos;s blog" />
</head>
<body><header class="site-header" role="banner">
  <div class="wrapper"><a class="site-title" rel="author" href="/">Zongjian&#39;s blog</a>

    <nav class="site-nav">
      <a class="page-link" href="/">Home</a>
      <a class="page-link" href="/categories/">Categories</a>
      <a class="page-link" href="/tags/">Tags</a>
      <a class="page-link" href="/archive/">Archive</a>
    </nav>
  </div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Mini Linux发行版</h1>
    <div class="post-meta">
      <time class="dt-published" datetime="2024-01-10T18:06:00-05:00" itemprop="datePublished">
        January 10, 2024
      </time></div>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>发行版跟内核比, 复杂多了. 你得有个安装程序, 有个包管理器, 有个软件仓库, 有个GUI, 有个桌面, 有个窗口管理器, 有个登录管理器, 有个网络管理器, 有个音频管理器, 有个电源管理器, 有个文件管理器, 有个文本编辑器, 有个终端模拟器, 有个浏览器, 有个邮件客户端, 有个音乐播放器, 有个视频播放器, 有个图片查看器, 有个PDF阅读器, 有个打印机管理器, 有个截图工具, 有个录屏工具, 有个截屏工具, 有个系统监控工具, 有个系统设置工具, 有个系统日志工具, 有个系统更新工具, 有个系统备份工具, 有个系统还原工具…… 但是核心的东西其实就三块:</p>

<ul>
  <li>Boot loader</li>
  <li>Kernel</li>
  <li>用户态程序</li>
</ul>

<p>把这三个弄齐了, 你就可以号称有发行版了. 所以我们现在开始吧, 所有操作都是在一台Ubuntu 22.04的虚拟机上完成的.</p>

<h2 id="1-install-prerequisite">1. install prerequisite</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt <span class="nb">install </span>build-essential flex libncurses5-dev bc libelf-dev bison libssl-dev
</code></pre></div></div>

<p>这些包待会编译的时候都用得到.</p>

<h2 id="2-build-the-source">2. build the source</h2>

<p>内核编译反倒比较简单, 且这20年几乎没变过. 不过源代码可以直接互联网上check out了, 不用从光盘拷贝了.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone <span class="nt">--depth</span><span class="o">=</span>1 https://github.com/torvalds/linux.git

make menuconfig
make <span class="nt">-j</span> 32
</code></pre></div></div>

<p>我这台虚拟机有32个vCPU, 所以启动32个并行进程编译. 一般来说, 你的CPU有多少个核, 就启动多少个并行进程. 不得不说, 计算机的发展还是可以看得见的, 基本上10几分钟就编译完了. 我基本上是默认设置, 就是禁用了两个配置</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@jason-builder:/data/linux# ./scripts/config <span class="nt">--disable</span> SYSTEM_TRUSTED_KEYS
root@jason-builder:/data/linux# ./scripts/config <span class="nt">--disable</span> SYSTEM_REVOCATION_KEYS
</code></pre></div></div>

<h2 id="3-build-busybox">3. build busybox</h2>

<p>有了内核, 还要有用户态程序, 一般来说就是shell, 我选了busybox, 因为它的功能很全, 而且体积很小. 你可以把它当成一个超级shell, 里面有很多命令. 以前嵌入式Linux都用它. 我就改了一个配置, 把它编译成了静态链接的可执行文件, 这样就不用担心依赖问题了.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone <span class="nt">--depth</span><span class="o">=</span>1 https://git.busybox.net/busybox/
make <span class="nt">-j</span> 32
<span class="nb">mkdir</span> /data/boot/initramfs
make <span class="nv">CONFIG_PREFIX</span><span class="o">=</span>/data/boot/initramfs <span class="nb">install
cd</span> /data/boot/initramfs
vi init <span class="c"># add shebang</span>
<span class="nb">chmod</span> +x init
<span class="nb">rm </span>linuxrc
/data/boot/initramfs# find | cpio <span class="nt">-o</span> <span class="nt">-H</span> newc <span class="o">&gt;</span> ../init.cpio
</code></pre></div></div>

<h2 id="4-boot-loader">4. boot loader</h2>

<p>最后, 你得有个引导程序来启动你的内核. 当年我们的引导程序是LILO, 现在基本已经挂了, 都用GRUB. 我们自己的发行版用不到那么高大上, 用最简单的引导程序syslinux就可以了.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt <span class="nb">install </span>syslinux
<span class="nb">dd </span><span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>boot <span class="nv">bs</span><span class="o">=</span>1M <span class="nv">count</span><span class="o">=</span>50
mkfs.fat boot
syslinux boot
<span class="nb">mkdir </span>m
mount boot m
<span class="nb">cp </span>bzImage init.cpio ./m/
umount m
</code></pre></div></div>

<p>这样启动的话, 会失败, 需要手工输入内核和initramfs的路径. 为了方便, 我们可以用syslinux的配置文件来启动. syslinux.cfg的内容如下:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DEFAULT linux
LABEL linux
    KERNEL bzImage
    APPEND initrd=init.cpio
</code></pre></div></div>

<h2 id="5-boot">5. boot</h2>

<p>启动的话, 必须要用个有图形界面的虚拟机, 用VMWare, VirtualBox都可以. 用qemu也行. 我就用的是macos上的QEMU. 直接输入指令:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>qemu-system-x86_64 boot
</code></pre></div></div>

<p>然后系统就会跳出图形界面, 然后你就可以看到你自己的Linux启动了.</p>

<p><img src="/uploads/2024/linuxdistribution1.png" alt="mini-linux" /></p>

<p><img src="/uploads/2024/linuxdistribution2.png" alt="mini-linux-2" /></p>

<p>可以看到, 是最新的内核. 也可以运行一些简单的命令跟shell脚本. 但是网络是没有的, 所以没法ssh进去. 好了, 这基本上就是发行版的第一步了. 一些Raspberry Pi的发行版就是这么做的. 但是这样的发行版太简单了, 你连个网络都没有, 包管理器都没有, 你连个软件都装不上. 没人会用.</p>


  </div>

  <a class="u-url" href="/mini-linuxfa-xing-ban.html" hidden></a>
</article>


      </div>
    </main><link id="fa-stylesheet" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.0.0/css/all.min.css">

<footer class="site-footer h-card">
  <data class="u-url" value="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <ul class="contact-list">
          <li class="p-name">Zongjian He</li>
          <li><a class="u-email" href="mailto:"></a></li>
        </ul>
      </div>
      <div class="footer-col">
        <p>Personal blog of Zongjian He</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list">
  <li>
    <a href="https://www.hezongjian.com/feed.xml" target="_blank" title="Subscribe to syndication feed">
      <svg class="svg-icon grey" viewbox="0 0 16 16">
        <path d="M12.8 16C12.8 8.978 7.022 3.2 0 3.2V0c8.777 0 16 7.223 16 16h-3.2zM2.194
          11.61c1.21 0 2.195.985 2.195 2.196 0 1.21-.99 2.194-2.2 2.194C.98 16 0 15.017 0
          13.806c0-1.21.983-2.195 2.194-2.195zM10.606
          16h-3.11c0-4.113-3.383-7.497-7.496-7.497v-3.11c5.818 0 10.606 4.79 10.606 10.607z"
        />
      </svg>
    </a>
  </li>
</ul>
</div>

  </div>

</footer>

</body>

</html>
